# üîê Sistema de Google OAuth - MiTurno API

Sistema completo de autenticaci√≥n con Google OAuth 2.0 para registro y login simplificado de usuarios.

---

## üéØ **Caracter√≠sticas**

- ‚úÖ Login con cuenta de Google (Sign in with Google)
- ‚úÖ Registro autom√°tico de nuevos usuarios
- ‚úÖ Vinculaci√≥n de cuentas existentes
- ‚úÖ Asignaci√≥n autom√°tica de rol CLIENTE
- ‚úÖ Generaci√≥n de JWT token propio del sistema
- ‚úÖ Actualizaci√≥n autom√°tica de informaci√≥n de perfil
- ‚úÖ Foto de perfil desde Google

---

## üì° **Endpoints Disponibles**

### **1. GET `/api/auth/google/login`**

Inicia el flujo de autenticaci√≥n con Google. Redirige al usuario a la p√°gina de login de Google.

**Sin par√°metros requeridos**

**Response (200 OK):**
```json
{
  "authorization_url": "https://accounts.google.com/o/oauth2/auth?client_id=..."
}
```

**Uso:**
El frontend debe redirigir al usuario a esta URL para iniciar el login con Google.

**Errores:**
- `500`: Error generando URL de autorizaci√≥n

---

### **2. GET `/api/auth/google/callback`**

Callback autom√°tico de Google despu√©s de que el usuario autoriza la aplicaci√≥n. **No debe ser llamado directamente por el frontend.**

**Query Parameters:**
- `code` (required): C√≥digo de autorizaci√≥n de Google
- `state` (optional): Estado para validaci√≥n

**Response (302 Redirect):**
Redirige al frontend con:
```
http://localhost:3000/auth/success?token=eyJhbGc...&new_user=true
```

**Errores:**
- `400`: C√≥digo de autorizaci√≥n inv√°lido o ausente
- `401`: Error validando token de Google
- `500`: Error interno

---

### **3. POST `/api/auth/google/token`**

Valida un ID token de Google y retorna un JWT token del sistema. **Endpoint recomendado para integraciones frontend modernas.**

**Request Body:**
```json
{
  "id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjFmODNk..."
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "usuario": {
    "usuario_id": 15,
    "email": "usuario@gmail.com",
    "nombre": "Juan",
    "apellido": "P√©rez",
    "google_id": "105847362947284756391",
    "picture_url": "https://lh3.googleusercontent.com/a/...",
    "tipo_usuario": "CLIENTE",
    "activo": true
  },
  "es_nuevo_usuario": true
}
```

**Comportamiento:**
1. **Usuario nuevo:**
   - Crea usuario en BD con datos de Google
   - Asigna rol CLIENTE autom√°ticamente
   - Genera contrase√±a aleatoria (no utilizada)
   - Retorna `es_nuevo_usuario: true`

2. **Usuario existente por email:**
   - Vincula cuenta agregando `google_id`
   - Actualiza foto de perfil si no ten√≠a
   - Retorna `es_nuevo_usuario: false`

3. **Usuario existente por google_id:**
   - Login directo
   - Actualiza informaci√≥n de perfil
   - Retorna `es_nuevo_usuario: false`

**Errores:**
- `400`: Token inv√°lido o ausente
- `401`: Error validando con Google
- `500`: Error interno

---

## üîê **Configuraci√≥n**

### **Variables de Entorno**

Agrega estas variables a tu `.env`:

```env
# Google OAuth
GOOGLE_CLIENT_ID=123456789-abcdefgh.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxxxxxxxxxxx
GOOGLE_REDIRECT_URI=http://localhost:8000/api/auth/google/callback

# Solo para desarrollo local (permite HTTP)
OAUTHLIB_INSECURE_TRANSPORT=1
```

**Producci√≥n (Fly.io):**
```bash
fly secrets set GOOGLE_CLIENT_ID="tu_client_id.apps.googleusercontent.com"
fly secrets set GOOGLE_CLIENT_SECRET="GOCSPX-tu_secret"
fly secrets set GOOGLE_REDIRECT_URI="https://turnos-api.fly.dev/api/auth/google/callback"

# NO configurar OAUTHLIB_INSECURE_TRANSPORT en producci√≥n
```

---

## üõ†Ô∏è **Configuraci√≥n de Google Cloud Console**

### **Paso 1: Crear Proyecto**

1. Ve a [Google Cloud Console](https://console.cloud.google.com)
2. Click en "Nuevo Proyecto"
3. Nombre: "MiTurno Auth"
4. Crear

### **Paso 2: Configurar Pantalla de Consentimiento**

1. APIs y servicios ‚Üí Pantalla de consentimiento de OAuth
2. Tipo de usuario: **Usuarios externos**
3. Informaci√≥n de la aplicaci√≥n:
   - Nombre: **MiTurno**
   - Correo de asistencia: tu email
   - Logotipo: (opcional)
   - Informaci√≥n de contacto: tu email
4. Alcances: Agregar los siguientes scopes
   - `openid`
   - `.../auth/userinfo.email`
   - `.../auth/userinfo.profile`
5. Usuarios de prueba: Agregar tu email (para modo Testing)

### **Paso 3: Crear Credenciales OAuth**

1. APIs y servicios ‚Üí Credenciales
2. Crear credenciales ‚Üí ID de cliente de OAuth 2.0
3. Configuraci√≥n:

```
Tipo de aplicaci√≥n: Aplicaci√≥n web
Nombre: MiTurno Backend API

Or√≠genes de JavaScript autorizados (opcional para backend):
   http://localhost:3000
   https://tu-frontend.vercel.app

URIs de redireccionamiento autorizados (importante):
   http://localhost:8000/api/auth/google/callback
   https://turnos-api.fly.dev/api/auth/google/callback
```

4. Crear y **guardar** Client ID y Client Secret

---

## üß™ **Testing**

### **Opci√≥n 1: Flujo Completo (Redirect)**

1. **Iniciar login:**
   ```bash
   GET http://localhost:8000/api/auth/google/login
   ```

2. **Copiar `authorization_url` del response**

3. **Abrir URL en navegador:** Se abrir√° p√°gina de login de Google

4. **Autorizar la aplicaci√≥n**

5. **Ser√°s redirigido al callback** con el token:
   ```
   http://localhost:3000/auth/success?token=eyJhbGc...&new_user=true
   ```

### **Opci√≥n 2: Validaci√≥n de Token (Recomendado)**

**Desde Frontend:**
```javascript
// 1. Usuario hace click en "Sign in with Google"
import { GoogleLogin } from '@react-oauth/google';

<GoogleLogin
  onSuccess={(credentialResponse) => {
    // 2. Enviar token a tu backend
    fetch('http://localhost:8000/api/auth/google/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id_token: credentialResponse.credential
      })
    })
    .then(res => res.json())
    .then(data => {
      // 3. Guardar token y redirigir
      localStorage.setItem('token', data.access_token);
      if (data.es_nuevo_usuario) {
        window.location.href = '/onboarding';
      } else {
        window.location.href = '/dashboard';
      }
    });
  }}
  onError={() => {
    console.log('Login Failed');
  }}
/>
```

**Testing Manual en Swagger:**
1. Ve a `/docs`
2. Endpoint: `POST /api/auth/google/token`
3. Obt√©n un `id_token` v√°lido desde:
   - Herramienta: [Google OAuth Playground](https://developers.google.com/oauthplayground)
   - O desde tu frontend con `@react-oauth/google`
4. Pega el token en el body
5. Execute

---

## üé® **Integraci√≥n con Frontend**

### **React con @react-oauth/google**

**1. Instalaci√≥n:**
```bash
npm install @react-oauth/google
```

**2. Configuraci√≥n en App.js:**
```jsx
import { GoogleOAuthProvider } from '@react-oauth/google';

function App() {
  return (
    <GoogleOAuthProvider clientId="tu_client_id.apps.googleusercontent.com">
      <YourApp />
    </GoogleOAuthProvider>
  );
}
```

**3. Componente de Login:**
```jsx
import { GoogleLogin } from '@react-oauth/google';
import { useState } from 'react';

function LoginPage() {
  const [loading, setLoading] = useState(false);

  const handleGoogleSuccess = async (credentialResponse) => {
    setLoading(true);
    
    try {
      const response = await fetch('https://turnos-api.fly.dev/api/auth/google/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id_token: credentialResponse.credential
        })
      });

      if (!response.ok) throw new Error('Login failed');

      const data = await response.json();
      
      // Guardar token
      localStorage.setItem('token', data.access_token);
      localStorage.setItem('usuario', JSON.stringify(data.usuario));

      // Redirigir seg√∫n tipo de usuario
      if (data.es_nuevo_usuario) {
        window.location.href = '/bienvenida';
      } else {
        window.location.href = '/dashboard';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al iniciar sesi√≥n con Google');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="login-container">
      <h1>Iniciar Sesi√≥n</h1>
      
      <GoogleLogin
        onSuccess={handleGoogleSuccess}
        onError={() => alert('Error al conectar con Google')}
        useOneTap
        text="signin_with"
        shape="rectangular"
        size="large"
      />
      
      {loading && <p>Iniciando sesi√≥n...</p>}
    </div>
  );
}
```

### **Vue 3**

```vue
<template>
  <div class="login">
    <h1>Iniciar Sesi√≥n</h1>
    <div id="g_id_onload"
         :data-client_id="clientId"
         data-callback="handleGoogleLogin">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>
</template>

<script setup>
import { onMounted } from 'vue';

const clientId = import.meta.env.VITE_GOOGLE_CLIENT_ID;

onMounted(() => {
  // Cargar script de Google
  const script = document.createElement('script');
  script.src = 'https://accounts.google.com/gsi/client';
  script.async = true;
  document.head.appendChild(script);
  
  // Callback global
  window.handleGoogleLogin = async (response) => {
    try {
      const res = await fetch('https://turnos-api.fly.dev/api/auth/google/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token: response.credential })
      });
      
      const data = await res.json();
      localStorage.setItem('token', data.access_token);
      window.location.href = '/dashboard';
    } catch (error) {
      console.error('Error:', error);
    }
  };
});
</script>
```

---

## üóÑÔ∏è **Base de Datos**

### **Campos en Usuario**

```sql
ALTER TABLE usuario
ADD COLUMN google_id VARCHAR(255) UNIQUE NULL,
ADD COLUMN picture_url VARCHAR(500) NULL,
ADD INDEX idx_google_id (google_id);
```

Los campos agregados:
- `google_id`: ID √∫nico del usuario en Google (ej: "105847362947284756391")
- `picture_url`: URL de la foto de perfil de Google

---

## üîç **Troubleshooting**

### **Error: "redirect_uri_mismatch"**

**Causa:** La URI de redirecci√≥n no coincide con la configurada en Google Cloud Console.

**Soluci√≥n:**
1. Ve a Google Cloud Console ‚Üí Credenciales
2. Edita tu cliente OAuth
3. Verifica que las URIs sean exactamente:
   - `http://localhost:8000/api/auth/google/callback` (local)
   - `https://turnos-api.fly.dev/api/auth/google/callback` (producci√≥n)

---

### **Error: "invalid_grant"**

**Causa:** El c√≥digo de autorizaci√≥n expir√≥ o ya fue usado.

**Soluci√≥n:**
- Los c√≥digos de Google expiran en ~10 minutos
- Reinicia el flujo de login
- No reutilices c√≥digos/tokens

---

### **Error: "OAUTHLIB_INSECURE_TRANSPORT"**

**Causa:** Intentando usar HTTP en lugar de HTTPS.

**Soluci√≥n para desarrollo local:**
```env
OAUTHLIB_INSECURE_TRANSPORT=1
```

**Para producci√≥n:** NO agregues esta variable, usa HTTPS siempre.

---

### **Usuario creado pero sin rol**

**Causa:** Tabla `rol` vac√≠a o rol CLIENTE no existe.

**Soluci√≥n:**
```sql
-- Verificar que existe el rol CLIENTE
SELECT * FROM rol WHERE nombre = 'CLIENTE';

-- Si no existe, crearlo
INSERT INTO rol (nombre, descripcion, tipo, nivel, activo)
VALUES ('CLIENTE', 'Usuario cliente del sistema', 'SISTEMA', 1, true);
```

---

### **Error: "User not found" despu√©s de login**

**Causa:** El usuario se cre√≥ pero no se retorn√≥ correctamente.

**Soluci√≥n:**
```python
# Verificar en el c√≥digo que despu√©s de crear usuario se haga:
db.commit()
db.refresh(usuario)  # ‚Üê Importante para obtener el ID
```

---

## üìä **Flujo Completo del Sistema**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ
‚îÇ  (Frontend) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Click "Sign in with Google"
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Google Login    ‚îÇ
‚îÇ  Popup/Redirect  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 2. Usuario autoriza
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Google OAuth    ‚îÇ
‚îÇ  id_token        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 3. POST /api/auth/google/token
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MiTurno Backend (FastAPI)‚îÇ
‚îÇ  - Valida token           ‚îÇ
‚îÇ  - Busca/crea usuario     ‚îÇ
‚îÇ  - Asigna rol CLIENTE     ‚îÇ
‚îÇ  - Genera JWT propio      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 4. Response con JWT
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend   ‚îÇ
‚îÇ  - Guarda   ‚îÇ
‚îÇ    token    ‚îÇ
‚îÇ  - Redirige ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ **Mejores Pr√°cticas**

### **Seguridad**

1. **Nunca expongas el Client Secret en el frontend**
   - Solo debe estar en el backend
   - Usa variables de entorno

2. **Valida siempre el token en el backend**
   - No conf√≠es solo en el frontend
   - Verifica con la API de Google

3. **Usa HTTPS en producci√≥n**
   - Nunca uses `OAUTHLIB_INSECURE_TRANSPORT=1` en prod
   - Google rechazar√° conexiones inseguras

### **UX**

1. **Muestra estados de carga**
   ```jsx
   {loading && <Spinner />}
   ```

2. **Maneja errores gracefully**
   ```jsx
   onError={() => {
     toast.error('No se pudo conectar con Google. Intenta nuevamente.');
   }}
   ```

3. **Diferencia usuarios nuevos de existentes**
   ```jsx
   if (data.es_nuevo_usuario) {
     // Mostrar tutorial o bienvenida
   } else {
     // Ir directo al dashboard
   }
   ```

---

## üìö **Referencias**

- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google Sign-In for Web](https://developers.google.com/identity/gsi/web)
- [OAuth 2.0 Playground](https://developers.google.com/oauthplayground)
- [@react-oauth/google](https://www.npmjs.com/package/@react-oauth/google)

---

## üöÄ **Roadmap**

- [ ] Soporte para Apple Sign-In
- [ ] Soporte para Microsoft Account
- [ ] Refresh token para sesiones largas
- [ ] Desvinculaci√≥n de cuenta Google
- [ ] Login con m√∫ltiples m√©todos (email + Google)

---

**√öltima actualizaci√≥n:** 20 de Octubre 2025  
**Versi√≥n:** 1.0.0  
**Estado:** ‚úÖ Productivo y funcional